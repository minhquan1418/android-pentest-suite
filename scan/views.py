from django.http import HttpResponse
from django.http import JsonResponse
from django.shortcuts import render
import subprocess
import utils.report_handle as report_handle
import utils.common as common
from report.models import ReportQark, ReportDc, ReportSniffgit

"""
khi ket noi, hien thi thong tin co ban va danh sach cac ung dung
"""
def connect(request, method, ip):
    # ket qua ket noi
    isSuccess = True
    # thong tin dien thoai
    phone_infos = []
    app_list = []

    if method == '1':
        output_lines = subprocess.check_output(["sh", "scripts/connect_by_ip.sh", ip])
    else:
        pass    # method == 0 -> usb

    # ket qua ket noi
    connectResult = output_lines.splitlines()[-1]
    if connectResult == "1":
        # xoa resource cu
        common.delete_old_resource()
        isSuccess = True
        # lay thong tin co ban cua dien thoai
        phone_infos = subprocess.check_output(["sh", "scripts/get_phone_info.sh"])
        phone_infos = phone_infos.splitlines()
        request.session['phone_infos'] = phone_infos
        # lay danh sach app cua dien thoai
        subprocess.check_output(["sh", "scripts/get_app_list.sh"])
        app_list = common.get_app_list()
        request.session['app_list'] = app_list
    else:
        isSuccess = False
    
    # ket qua tra ve
    data = {'success': isSuccess, 'phone_infos': phone_infos, 'app_list': app_list}
    return JsonResponse(data)


"""
hien thi report khi nhan tung nut
"""
def scan_one(request, app_name):
    # pull file apk tu dien thoai
    common.pull_apk(app_name)
    return render(request, 'scan_one.html', {'data': {'app_name': app_name, 'toolList': common.get_tool_list()}})


"""
su dung tung tool
"""
def scan_tool(request, app_name, tool_index):
    reports = []

    # common.use_tool --> save db
    try:
        common.use_tool(app_name, tool_index)
    except:
        pass
    # get all reports from all reports table    

    return render(request, 'scan_one.html', {'data': {
        'app_name': app_name,
        'toolList': common.get_tool_list(),
        'qark_reports': ReportQark.objects.all(),
        'dc_reports': ReportDc.objects.all(),
        'sniffgit_reports': ReportSniffgit.objects.all()
    }})