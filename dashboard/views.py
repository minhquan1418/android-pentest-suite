from django.http import HttpResponse
from django.shortcuts import render
from django.conf import settings
from django.core.files.storage import FileSystemStorage
from .forms import IpForm

def index(request):    
    return render(request, 'dashboard.html')

def connect_upload(request):
    # TODO: xoa resource cu
    
    # xu ly file apk duoc upload
    if request.method == 'POST' and request.FILES['apk_file']:
        apk_file = request.FILES['apk_file']
        fs = FileSystemStorage()
        apk_name = fs.save(apk_file.name, apk_file)
    # ghi ten apk vao app_list.txt
    app_list = open('outdir/app_list.txt','w')
    app_list.writelines(apk_name)
    app_list.close()

    return render(request, 'dashboard.html', {
        'isFailed' : False,
        'isOk' : True
    })

def connect_ip(request):
    # TODO: xoa resource cu

    isOk = True

    if request.method == 'POST':
        form = IpForm(request.POST)

        # TODO: test lai
        subprocess.check_output(["adb", "connect", form.ip])
        # ket qua ket noi
        connectResult = subprocess.check_output(["adb", "get-state"])
        if connectResult.strip() == "device":
            # lay danh sach app cua dien thoai
            subprocess.check_output(["sh", "scripts/get_app_list.sh"])
        else:
            isOk = False

    return render(request, 'dashboard.html', {
        'isFailed' : not isOk,
        'isOk' : isOk
    })