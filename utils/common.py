import subprocess
import os
from report.models import *
import utils.report_handle as report_handle

"""
Lay danh sach cac tool
"""
def get_tool_list():
    return ['Qark', 'Dependency Check', 'Sniffgit', 'AndroBugs']


"""
Lay danh sach cac app trong dien thoai
"""
def get_app_list():
    apps = open("outdir/app_list.txt", "r")
    appList = []
    for app in apps:
        appList.append(app.rstrip())
    return appList

"""
Pull apk tu dien thoai
"""
def pull_apk(app_name):
    # kiem tra file ton tai
    if not os.path.isfile('outdir/file/' + app_name):
        subprocess.check_output(["sh", "scripts/pull_file.sh", app_name])


"""
xoa resource cu
"""
def delete_old_resource():
    # delete files
    subprocess.check_output(["sh", "scripts/remove.sh"])
    # delete db
    ReportQark.objects.all().delete()
    ReportDc.objects.all().delete()
    ReportSniffgit.objects.all().delete()
    ReportAndro.objects.all().delete()

"""
dua vao tool_index, chay tool duoc yeu cau
"""
def use_tool(app_name, tool_index):
    # cac tool se decompile
    if "3" == tool_index:
        report_andro(app_name)
    else:
        report_qark(app_name)

    # kiem tra db xem da su dung tool_index chua
    if "1" == tool_index:
        report_dc(app_name)
    if "2" == tool_index:
        report_sniffgit(app_name)
    # neu chua thi --> switch case
    return


"""
su dung tool qark
"""
def report_qark(app):    
    # kiem tra db xem da su dung tool nay cho app can scan chua
    if 0 == ReportQark.objects.filter(app_name=app).count():
        # chay qark
        subprocess.check_output(["sh", "scripts/report_qark.sh", app])
        # xu ly ket qua report
        report_handle.handle_qark_report(app)


"""
su dung tool dependency check
"""
def report_dc(app):
    if 0 == ReportDc.objects.filter(app_name=app).count():
        # chay dependency check
        subprocess.check_output(["sh", "scripts/report_dc.sh", app.replace('.apk', '')])
        # xu ly ket qua report
        report_handle.handle_dc_report(app)

"""
su dung tool sniffgit
"""
def report_sniffgit(app):
    if 0 == ReportSniffgit.objects.filter(app_name=app).count():
        #subprocess.check_output(["sh", "scripts/report_sniffgit.sh", app])
        report_handle.handle_sniffgit_report(app)

"""
su dung tool AndrogBugs
"""
def report_andro(app):
    if not os.path.isfile('outdir/report/' + app + '_andro.txt'):
        subprocess.check_output(["sh", "scripts/report_andro.sh", app])